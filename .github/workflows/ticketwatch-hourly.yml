name: ğŸŸï¸ Ticketwatch Hourly Monitor

on:
  schedule:
    # Run every hour at minute 0
    - cron: '0 * * * *'
  workflow_dispatch:
    # Allow manual trigger
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'

jobs:
  ticketwatch:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Increased timeout for slower requests
    
    env:
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT: ${{ secrets.TG_CHAT }}
      PRIMARY: "true"
      GITHUB_ACTIONS: "true"  # Enable GitHub Actions optimizations
      
    steps:
    - name: ğŸš€ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ” System health check
      run: |
        echo "ğŸ” Checking system health..."
        echo "ğŸ“Š Batch URLs:"
        for file in url_batches/batch*.txt; do
          count=$(grep -v '^#' "$file" | grep -c 'http' || echo '0')
          echo "  - $(basename "$file"): $count URLs"
        done
        total=$(find url_batches -name "batch*.txt" -exec grep -v '^#' {} \; | grep -c 'http' || echo '0')
        echo "ğŸ“Š Total batch URLs: $total"
        echo "ğŸ“„ State file size: $(wc -l < state.json || echo '0') lines"
        echo "ğŸŒ Environment: GitHub Actions"
        
    - name: ğŸŸï¸ Run Ticketwatch (Batch System)
      run: |
        echo "ğŸš€ Starting Ticketwatch with batch system..."
        echo "ğŸ“Š Processing all batch files in parallel..."
        
        # Run each batch file in parallel
        python ticketwatch_v2.py url_batches/batch1.txt &
        python ticketwatch_v2.py url_batches/batch2.txt &
        python ticketwatch_v2.py url_batches/batch3.txt &
        python ticketwatch_v2.py url_batches/batch4.txt &
        python ticketwatch_v2.py url_batches/batch5.txt &
        
        # Wait for all batches to complete
        wait
        
        echo "âœ… All batches completed"
        
    - name: ğŸ’¾ Commit and push changes
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Pull latest changes first to avoid conflicts
        git pull origin main --rebase --autostash || true
        
        # Check if there are changes to commit
        if [[ `git status --porcelain` ]]; then
          echo "ğŸ“ Changes detected, committing..."
          git add state.json urls.txt failed_urls.json
          git commit -m "ğŸ¤– Update state, URLs, and failed URL tracking ($(date))" || echo "âš ï¸ Commit failed or no changes"
          
          # Try to push with retry
          for i in {1..3}; do
            if git push; then
              echo "âœ… Changes pushed to repository"
              break
            else
              echo "âš ï¸ Push failed, attempt $i/3. Pulling latest changes..."
              git pull origin main --rebase --autostash || true
              if [ $i -eq 3 ]; then
                echo "âŒ Failed to push after 3 attempts"
                exit 1
              fi
            fi
          done
        else
          echo "âœ… No changes to commit"
        fi
        
    - name: ğŸ“Š Run summary
      if: always()
      run: |
        echo "=================================="
        echo "ğŸŸï¸ TICKETWATCH RUN SUMMARY"
        echo "=================================="
        echo "â° Completed at: $(date)"
        echo "ğŸ“Š Batch URLs processed:"
        for file in url_batches/batch*.txt; do
          count=$(grep -v '^#' "$file" | grep -c 'http' || echo '0')
          echo "  - $(basename "$file"): $count URLs"
        done
        total=$(find url_batches -name "batch*.txt" -exec grep -v '^#' {} \; | grep -c 'http' || echo '0')
        echo "ğŸ“Š Total URLs: $total"
        echo "ğŸ“„ State entries: $(wc -l < state.json || echo '0') lines"
        echo "ğŸ”„ Status: ${{ job.status }}"
        echo "=================================="