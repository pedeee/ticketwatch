name: Ticket watch

on:
  schedule:
    - cron: '0 * * * *'   # every hour
  workflow_dispatch:

jobs:
  watch:
    strategy:
      matrix:
        batch:
          - url_batches/batch1.txt
          - url_batches/batch2.txt
          - url_batches/batch3.txt
          - url_batches/batch4.txt
          - url_batches/batch5.txt
    runs-on: ubuntu-latest
    env:
      URL_FILE:   ${{ matrix.batch }}
      STATE_FILE: ${{ matrix.batch }}.state.json   # <─ unique per batch
      TG_TOKEN:   ${{ secrets.TG_TOKEN }}
      TG_CHAT:    ${{ secrets.TG_CHAT }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Install deps
        run: pip install requests beautifulsoup4 cloudscraper python-dateutil
      - name: Run watcher
        id: runwatch
        run: python ticketwatch.py

    outputs:
      changed: ${{ steps.runwatch.outputs.changed }}

  summary:
    needs: watch
    if: ${{ needs.watch.outputs.changed == 'False' }}   # only when none changed
    runs-on: ubuntu-latest
    env:
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT:  ${{ secrets.TG_CHAT }}
    steps:
      - name: Send no-change heartbeat
        run: curl -s -d chat_id="$TG_CHAT" -d text="✅ Ticketwatch – No changes in the last hour" \
             https://api.telegram.org/bot$TG_TOKEN/sendMessage
