name: ğŸŸï¸ Ticketwatch Conservative Monitor (All 26 Batches)

on:
  schedule:
    # Run every 12 hours (ultra-conservative frequency)
    - cron: '0 */12 * * *'
  workflow_dispatch:
    # Allow manual trigger for testing
    inputs:
      batches:
        description: 'Batches to run (e.g., "1-5" or "all")'
        required: false
        default: 'all'

jobs:
  # Run all batches SEQUENTIALLY with delays between them
  run-all-batches:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours max
    
    env:
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT: ${{ secrets.TG_CHAT }}
      GITHUB_ACTIONS: "true"
      
    steps:
    - name: ğŸš€ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        playwright install chromium
        playwright install-deps chromium

    - name: ğŸŸï¸ Run All Batches Sequentially (Ultra-Conservative)
      run: |
        echo "ğŸš€ Starting ultra-conservative batch scan..."
        echo "âš™ï¸  Settings: Sequential processing, 2-min delays between batches"
        echo "ğŸ“Š Total batches: 26 (20 URLs each)"
        echo ""
        
        # Track overall stats
        total_batches=26
        successful_batches=0
        failed_batches=0
        
        # Run each batch sequentially with delays
        for i in {1..26}; do
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ Processing batch $i/$total_batches..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if python ticketwatch_v2.py url_batches/batch$i.txt; then
            echo "âœ… Batch $i completed successfully"
            ((successful_batches++))
          else
            echo "âŒ Batch $i failed"
            ((failed_batches++))
          fi
          
          # Add 2-minute delay between batches (except after last batch)
          if [ $i -lt $total_batches ]; then
            echo ""
            echo "â³ Waiting 2 minutes before next batch..."
            sleep 120
            echo ""
          fi
        done
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š FINAL SUMMARY"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Successful batches: $successful_batches/$total_batches"
        echo "âŒ Failed batches: $failed_batches/$total_batches"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Fail the job if any batches failed
        if [ $failed_batches -gt 0 ]; then
          exit 1
        fi

    - name: ğŸ“¤ Commit and push changes
      if: always()
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add url_batches/*.json url_batches/*.txt
        git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ¤– Auto-update: Batch scan results [skip ci]"
        git push || echo "âš ï¸  No changes to push"
